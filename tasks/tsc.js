/*******************************************************************************
 *                                  ,     ,     ,
 *                                  `$,    $,   `$,      ;
 *                                   `$+   `$,   `$,    d;     ,
 *                                    `$b,  `$,   $$,  d$'   ,$
 *     ╔═══╗╔╗╔╗╔╗ ╔╗╔╗╔══╗            `$$+  l$+  ;$$ d$$   ,$'    ,
 *     ║╔═╗║║║║║║╚═╝║║║║╔═╝             `$$b,;$$b,$$$$$$; ,d$$   ,$
 *     ║╚═╝║║║║║║╔╗ ║║╚╝║                `$$$b$$$$$$$$$$$$$$$; ,d$'
 *     ║╔══╝║║║║║║╚╗║║╔╗║                 `$$$*""""~~""^¦$$$$$$$$P    ,,
 *     ║║   ║╚╝║║║ ║║║║║╚═╗               *^              ~^"$$$$;_,s$'
 *     ╚╝   ╚══╝╚╝ ╚╝╚╝╚══╝             ,^                    `$$$$$$'    _
 *                                     ,'                       `$$$'  ,y$"
 *                                     '                         `$$,y$$"
 *        ╔╗ ╔╗╔══╗╔════╗             (                           `$$$$'
 *        ║╚═╝║║╔╗║╚═╗╔═╝           ,^       ,,,         ,,,yyyyy,,`$$$$$#=-
 *        ║╔╗ ║║║║║  ║║             `\,  ,,/'^  ``      `$$$$$$$$$$d;$$$~
 *        ║║╚╗║║║║║  ║║              /' ,$$*=``-     `$b`?$$$$$$$$$$;$$$b,
 *        ║║ ║║║╚╝║  ║║            ,'   `^*;-=''    `$$$$$$$#$$$$$$$;$$$¦$b.
 *        ╚╝ ╚╝╚══╝  ╚╝           (,,,;,             `¦$-",¬y+`?$$$$;$b,
 *                                 `;``"                 ]$& $';$$$$d$$$b,
 *                                ,yyy,,                +@@&`'d$$$$d$P""¦$,
 *     ╔══╗ ╔═══╗╔══╗╔══╗         \?`^"$@by,            ~¦>^,$$$$$d$$b,
 *     ║╔╗╚╗║╔══╝║╔╗║║╔╗╚╗        ,&~`^"¦?~#`        ,yb, ,?$$$$$d$$$$b,
 *     ║║╚╗║║╚══╗║╚╝║║║╚╗║       '   $    ,      ,,yd$$$$$?·?$$$d$$~~"¦;
 *     ║║ ║║║╔══╝║╔╗║║║ ║║      /   '$, $$$yyyyy$$$$$" ,$$$+$$$d$$$b,
 *     ║╚═╝║║╚══╗║║║║║╚═╝║     `-=##$$$$$$$$$$$$$$^~  ,$$$$$$$R$'~  ~`
 *     ╚═══╝╚═══╝╚╝╚╝╚═══╝           ~~"$$$$$$$$$'   ,$$$$$$$D$'
 *                                       `#$$$$$'   ,$$$`,$$Z$$
 *                                         `#$$'   ,$@P',$$o$$'
 *                                           `'=*yd$$P',$$N$P'
 *                                                ~~~"+$-"~
 *
 *   ╔══╗ ╔══╗╔═══╗╔══╗╔════╗╔══╗╔╗      ╔═══╗╔╗  ╔═══╗╔╗  ╔╗╔═══╗╔╗ ╔╗╔════╗
 *   ║╔╗╚╗╚╗╔╝║╔══╝╚╗╔╝╚═╗╔═╝║╔╗║║║      ║╔══╝║║  ║╔══╝║╚╗╔╝║║╔══╝║╚═╝║╚═╗╔═╝
 *   ║║╚╗║ ║║ ║║╔═╗ ║║   ║║  ║╚╝║║║  ╔══╗║╚══╗║║  ║╚══╗║ ╚╝ ║║╚══╗║╔╗ ║  ║║
 *   ║║ ║║ ║║ ║║╚╗║ ║║   ║║  ║╔╗║║║  ╚══╝║╔══╝║║  ║╔══╝║╔╗╔╗║║╔══╝║║╚╗║  ║║
 *   ║╚═╝║╔╝╚╗║╚═╝║╔╝╚╗  ║║  ║║║║║╚═╗    ║╚══╗║╚═╗║╚══╗║║╚╝║║║╚══╗║║ ║║  ║║
 *   ╚═══╝╚══╝╚═══╝╚══╝  ╚╝  ╚╝╚╝╚══╝    ╚═══╝╚══╝╚═══╝╚╝  ╚╝╚═══╝╚╝ ╚╝  ╚╝
 *
 *      project: grunt-tsc
 *      version: 0.0.2
 *  development: http://www.digital-element.ru/
 *    copyright: (c) 2003-2014 Digital-Element
 *      license: MIT
 ******************************************************************************/
var spawn=require("child_process").spawn,path=require("path"),fs=require("fs");module.exports=function(a){"use strict";a.registerMultiTask("tsc","Compile *.ts files",function(){function b(){return"undefined"==typeof t&&(t=F.options()||{}),t}function c(){var a,c;if("string"!=typeof x)if(a=b(),c=String(a.target||"").toUpperCase(),"undefined"==typeof a.target||"DEFAULT"===c)x="ES3";else if("LATEST"===c)x="ES6";else{if(-1===["ES3","ES5","ES6"].indexOf(c))throw new Error("bla bla bla");x=c}return x}function d(){var a,c;if("string"!=typeof y)if(a=b(),c=String(a.module||"").toLowerCase(),"undefined"==typeof a.module)y="commonjs";else{if(-1===["commonjs","amd"].indexOf(c))throw new Error("bla bla bla");y=c}return y}function e(){return"undefined"==typeof B&&(B=path.join(__dirname,"../bin/tsc.js")),B}function f(){var a;return"undefined"==typeof v&&(a=b(),v="string"==typeof a.declaration?-1===["off","no","false","0",""].indexOf(String(a.declaration).toLowerCase()):!!a.declaration),!!v}function g(){var a;return"undefined"==typeof C&&(a=b(),C="undefined"==typeof a.comments?!0:"string"==typeof a.comments?-1===["off","no","false","0",""].indexOf(String(a.comments).toLowerCase()):!!a.comments),!!C}function h(){var a;return"undefined"==typeof w&&(a=b(),w="string"==typeof a.sourcemap?-1===["off","no","false","0",""].indexOf(String(a.sourcemap).toLowerCase()):!!a.sourcemap),!!w}function i(){var a;return"undefined"==typeof D&&(a=b(),D="undefined"==typeof a.implicitAny?!0:"string"==typeof a.implicitAny?-1===["off","no","false","0",""].indexOf(String(a.implicitAny).toLowerCase()):!!a.implicitAny),!!D}function j(){var a;return"undefined"==typeof E&&(a=b(),E="string"==typeof a.preserveConstEnums?-1===["off","no","false","0",""].indexOf(String(a.preserveConstEnums).toLowerCase()):!!a.preserveConstEnums),!!E}function k(){return"undefined"==typeof A&&(A=String(t.sourceRoot||"")||null),A}function l(){return"undefined"==typeof z&&(z=String(t.mapRoot||"")||null),z}function m(){var a;return"undefined"==typeof u&&(a=b(),u=String(a.encoding||"utf8")||"utf8"),u}function n(a){for(var b,c=["B","K","M","G","T"],d=c.shift(),e=!1;a>1024;)a/=1024,d=c.shift(),e=!0;return b=String(a+1e-4).split("."),b[0]+(e?"."+b[1].substr(0,1):"")+d}function o(a){var b="",c=spawn("/usr/bin/env",["node",e(),"--version"]);c.stderr.on("data",function(a){b+=a.toString()}),c.stdout.on("data",function(a){b+=a.toString()}),c.on("close",function(c){0!==c||a(/^.*version\s+(\S+).*$/im.test(b)?b.replace(/^.*version\s+(\S+).*$/im,"$1").split("\r").join("").split("\n").join(""):"unknown")})}function p(a){var b=String(a/1e3+1e-4).split(".");return b[0]+(b.length>1?"."+b[1].substr(0,3):".000")+"s"}function q(){var b=K+J+L;a.log.writeln(["%count% files".replace(/%count%/g,String(b)).cyan+" created."," js: "+"%count% files".replace(/%count%/g,String(K)).cyan+","," map: "+"%count% files".replace(/%count%/g,String(L)).cyan+","," declaration: "+"%count% files".replace(/%count%/g,String(J)).cyan+" ","(354ms)"].join("")),H()}function r(b){function o(){return"undefined"==typeof x&&(x=!!b.orig.expand),x}function s(){return"undefined"==typeof A&&(A=b.src),A}function t(){return"undefined"==typeof y&&(y=String(b.dest||"")),y}function u(){return"undefined"==typeof z&&(z=String(b.cwd||"")),z}function v(){function b(){var a=String(Number(new Date-Q)/1e3+1e-4).split(".");return a[0]+(a.length>1?"."+a[1].substr(0,3):".000")+"s"}function o(){var a,b,c,d;return"undefined"==typeof E&&(a=x(),b=path.extname(a),c=path.basename(a,b),d=path.dirname(a),E=path.join(d,c+".js")),E}function p(){var a,b,c,d;return"undefined"==typeof F&&(a=x(),b=path.extname(a),c=path.basename(a,b),d=path.dirname(a),F=path.join(d,c+".js.map")),F}function u(){var a,b,c,d;return"undefined"==typeof H&&(a=t(),c=path.extname(a),d=path.basename(a,c),b=path.dirname(a),H=path.join(b,d+".js.map")),H}function v(){var a,b,c,d;return"undefined"==typeof I&&(a=x(),b=path.extname(a),c=path.basename(a,b),d=path.dirname(a),I=path.join(d,c+".d.ts")),I}function w(){var a,b,c,d;return"undefined"==typeof M&&(a=t(),c=path.extname(a),d=path.basename(a,c),b=path.dirname(a),M=path.join(b,d+".d.ts")),M}function x(){return"undefined"==typeof N&&(N=String(s()[0]||"")),N}function y(){return"string"!=typeof C&&(C=path.basename(s()[0])),C}function z(){return"string"!=typeof D&&(D=path.dirname(s()[0])),D}function A(){function c(b,c,d){setTimeout(function(){a.file.copy(b,c,{encoding:m()}),a.file.delete(b,{force:!0}),d(null,fs.statSync(c),c)},0)}function d(c,d,e){c||(j--,k&&a.log.write("Compile".green+" "+x()+" ("+b()+")"),a.log.write((k?" -> ":", ")+e+" ("+n(d.size)+")"),j||(a.log.writeln("."),G.length?r(G.shift()):q()),k=!1)}function e(){j++,K++,c(o(),t(),d)}function g(){j++,J++,c(v(),w(),d)}function i(){j++,L++,c(p(),u(),d)}var j=0,k=!0;e(),f()&&g(),h()&&i()}var B,C,D,E,F,H,I,M,N,O=["node",e(),"--target",c(),"--module",d()],P=[],Q=Number(new Date);g()||O.push("--removeComments"),f()&&O.push("--declaration"),i()||O.push("--noImplicitAny"),j()&&O.push("--preserveConstEnums"),h()&&(O.push("--sourcemap"),null!==k()&&O.push("--sourceRoot",k()),null!==l()&&O.push("--mapRoot",l())),O.push(y()),B=spawn("/usr/bin/env",O,{cwd:z()}),B.stderr.on("data",function(a){P.push(a.toString())}),B.on("close",function(a){0!==a||A()})}function w(){var b,m=["node",e(),"--target",c(),"--module",d()],n=[];g()||m.push("--removeComments"),f()&&m.push("--declaration"),i()||m.push("--noImplicitAny"),j()&&m.push("--preserveConstEnums"),h()&&(m.push("--sourcemap"),null!==k()&&m.push("--sourceRoot",k()),null!==l()&&m.push("--mapRoot",l())),s().forEach(function(a){m.push(path.join(u(),a))}),m.push("--out",t()),b=spawn("/usr/bin/env",m),b.stderr.on("data",function(a){n.push(a.toString())}),b.on("close",function(b){0!==b?(a.verbose.or.error().error(n.join("\n")),a.fail.warn("Something went wrong."),H(!1)):(a.log.writeln("Compile %count% file(s), %time% sec".replace(/%count%/g,String(s().length).cyan).replace(/%time%/g,p(Number(new Date)-I).cyan)),H(!0))})}var x,y,z,A;o()?v():w()}function s(){o(function(b){a.log.writeln("Compiler version: "+b.green),a.log.writeflags({target:c(),module:d(),declaration:f().toString(),comments:g().toString(),sourcemap:h().toString(),implicitAny:i().toString(),preserveConstEnums:j().toString(),sourceRoot:k(),mapRoot:l(),encoding:m()},"Options"),G.length?r(G.shift()):q()})}var t,u,v,w,x,y,z,A,B,C,D,E,F=this,G=F.files,H=this.async(),I=Number(new Date),J=0,K=0,L=0;s()})};